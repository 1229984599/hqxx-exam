<template>
  <PageLayout
    title="ç³»ç»Ÿè®¾ç½®"
    subtitle="é…ç½®ç³»ç»Ÿå„é¡¹å‚æ•°å’ŒåŠŸèƒ½"
  >
    <el-tabs v-model="activeTab" class="settings-tabs">
      <!-- åŸºç¡€è®¾ç½® -->
      <el-tab-pane label="åŸºç¡€è®¾ç½®" name="basic">
        <div class="settings-section">
          <h3>ğŸ« å­¦æ ¡ä¿¡æ¯</h3>
          <el-form :model="basicSettings" label-width="120px" class="settings-form">
            <el-row :gutter="24">
              <el-col :span="12">
                <el-form-item label="å­¦æ ¡åç§°">
                  <el-input v-model="basicSettings.schoolName" placeholder="è¯·è¾“å…¥å­¦æ ¡åç§°" />
                </el-form-item>
              </el-col>
              
              <el-col :span="12">
                <el-form-item label="å­¦æ ¡ä»£ç ">
                  <el-input v-model="basicSettings.schoolCode" placeholder="è¯·è¾“å…¥å­¦æ ¡ä»£ç " />
                </el-form-item>
              </el-col>
            </el-row>
            
            <el-row :gutter="24">
              <el-col :span="12">
                <el-form-item label="è”ç³»ç”µè¯">
                  <el-input v-model="basicSettings.phone" placeholder="è¯·è¾“å…¥è”ç³»ç”µè¯" />
                </el-form-item>
              </el-col>
              
              <el-col :span="12">
                <el-form-item label="é‚®ç®±åœ°å€">
                  <el-input v-model="basicSettings.email" placeholder="è¯·è¾“å…¥é‚®ç®±åœ°å€" />
                </el-form-item>
              </el-col>
            </el-row>
            
            <el-form-item label="å­¦æ ¡åœ°å€">
              <el-input 
                v-model="basicSettings.address" 
                type="textarea" 
                :rows="3"
                placeholder="è¯·è¾“å…¥å­¦æ ¡åœ°å€"
              />
            </el-form-item>
            
            <el-form-item label="å­¦æ ¡ç®€ä»‹">
              <el-input 
                v-model="basicSettings.description" 
                type="textarea" 
                :rows="4"
                placeholder="è¯·è¾“å…¥å­¦æ ¡ç®€ä»‹"
              />
            </el-form-item>
          </el-form>
        </div>

        <div class="settings-section">
          <h3>âš™ï¸ ç³»ç»Ÿé…ç½®</h3>
          <el-form :model="basicSettings" label-width="120px" class="settings-form">
            <el-row :gutter="24">
              <el-col :span="12">
                <el-form-item label="ç³»ç»Ÿåç§°">
                  <el-input v-model="basicSettings.systemName" placeholder="è€ƒè¯•ç®¡ç†ç³»ç»Ÿ" />
                </el-form-item>
              </el-col>
              
              <el-col :span="12">
                <el-form-item label="ç³»ç»Ÿç‰ˆæœ¬">
                  <el-input v-model="basicSettings.version" placeholder="v1.0.0" readonly />
                </el-form-item>
              </el-col>
            </el-row>
            
            <el-row :gutter="24">
              <el-col :span="12">
                <el-form-item label="æ—¶åŒºè®¾ç½®">
                  <el-select v-model="basicSettings.timezone" placeholder="è¯·é€‰æ‹©æ—¶åŒº">
                    <el-option label="åŒ—äº¬æ—¶é—´ (UTC+8)" value="Asia/Shanghai" />
                    <el-option label="ä¸œäº¬æ—¶é—´ (UTC+9)" value="Asia/Tokyo" />
                    <el-option label="çº½çº¦æ—¶é—´ (UTC-5)" value="America/New_York" />
                  </el-select>
                </el-form-item>
              </el-col>
              
              <el-col :span="12">
                <el-form-item label="è¯­è¨€è®¾ç½®">
                  <el-select v-model="basicSettings.language" placeholder="è¯·é€‰æ‹©è¯­è¨€">
                    <el-option label="ç®€ä½“ä¸­æ–‡" value="zh-CN" />
                    <el-option label="ç¹ä½“ä¸­æ–‡" value="zh-TW" />
                    <el-option label="English" value="en-US" />
                  </el-select>
                </el-form-item>
              </el-col>
            </el-row>
            
            <el-row :gutter="24">
              <el-col :span="12">
                <el-form-item label="ç»´æŠ¤æ¨¡å¼">
                  <el-switch 
                    v-model="basicSettings.maintenanceMode"
                    active-text="å¼€å¯"
                    inactive-text="å…³é—­"
                  />
                </el-form-item>
              </el-col>
              
              <el-col :span="12">
                <el-form-item label="è°ƒè¯•æ¨¡å¼">
                  <el-switch 
                    v-model="basicSettings.debugMode"
                    active-text="å¼€å¯"
                    inactive-text="å…³é—­"
                  />
                </el-form-item>
              </el-col>
            </el-row>
          </el-form>
        </div>
      </el-tab-pane>

      <!-- å®‰å…¨è®¾ç½® -->
      <el-tab-pane label="å®‰å…¨è®¾ç½®" name="security">
        <div class="settings-section">
          <h3>ğŸ” ç™»å½•å®‰å…¨</h3>
          <el-form :model="securitySettings" label-width="150px" class="settings-form">
            <el-row :gutter="24">
              <el-col :span="12">
                <el-form-item label="å¯†ç æœ€å°é•¿åº¦">
                  <el-input-number 
                    v-model="securitySettings.minPasswordLength" 
                    :min="6" 
                    :max="20"
                  />
                </el-form-item>
              </el-col>
              
              <el-col :span="12">
                <el-form-item label="ç™»å½•å¤±è´¥é”å®šæ¬¡æ•°">
                  <el-input-number 
                    v-model="securitySettings.maxLoginAttempts" 
                    :min="3" 
                    :max="10"
                  />
                </el-form-item>
              </el-col>
            </el-row>
            
            <el-row :gutter="24">
              <el-col :span="12">
                <el-form-item label="Tokenæœ‰æ•ˆæœŸ(åˆ†é’Ÿ)">
                  <el-input-number 
                    v-model="securitySettings.tokenExpireMinutes" 
                    :min="30" 
                    :max="1440"
                  />
                </el-form-item>
              </el-col>
              
              <el-col :span="12">
                <el-form-item label="è´¦æˆ·é”å®šæ—¶é—´(åˆ†é’Ÿ)">
                  <el-input-number 
                    v-model="securitySettings.lockoutMinutes" 
                    :min="5" 
                    :max="60"
                  />
                </el-form-item>
              </el-col>
            </el-row>
            
            <el-row :gutter="24">
              <el-col :span="12">
                <el-form-item label="å¼ºåˆ¶å¤æ‚å¯†ç ">
                  <el-switch 
                    v-model="securitySettings.requireComplexPassword"
                    active-text="å¼€å¯"
                    inactive-text="å…³é—­"
                  />
                </el-form-item>
              </el-col>
              
              <el-col :span="12">
                <el-form-item label="å¯ç”¨åŒå› å­è®¤è¯">
                  <el-switch 
                    v-model="securitySettings.enableTwoFactor"
                    active-text="å¼€å¯"
                    inactive-text="å…³é—­"
                  />
                </el-form-item>
              </el-col>
            </el-row>
          </el-form>
        </div>

        <div class="settings-section">
          <h3>ğŸ›¡ï¸ ç³»ç»Ÿå®‰å…¨</h3>
          <el-form :model="securitySettings" label-width="150px" class="settings-form">
            <el-row :gutter="24">
              <el-col :span="12">
                <el-form-item label="IPç™½åå•">
                  <el-switch 
                    v-model="securitySettings.enableIpWhitelist"
                    active-text="å¼€å¯"
                    inactive-text="å…³é—­"
                  />
                </el-form-item>
              </el-col>
              
              <el-col :span="12">
                <el-form-item label="APIè®¿é—®é™åˆ¶">
                  <el-switch 
                    v-model="securitySettings.enableApiRateLimit"
                    active-text="å¼€å¯"
                    inactive-text="å…³é—­"
                  />
                </el-form-item>
              </el-col>
            </el-row>
            
            <el-form-item label="å…è®¸çš„IPåœ°å€" v-if="securitySettings.enableIpWhitelist">
              <el-input 
                v-model="securitySettings.allowedIps" 
                type="textarea" 
                :rows="3"
                placeholder="è¯·è¾“å…¥å…è®¸è®¿é—®çš„IPåœ°å€ï¼Œæ¯è¡Œä¸€ä¸ª"
              />
            </el-form-item>
          </el-form>
        </div>
      </el-tab-pane>

      <!-- æ–‡ä»¶è®¾ç½® -->
      <el-tab-pane label="æ–‡ä»¶è®¾ç½®" name="file">
        <div class="settings-section">
          <h3>ğŸ“ æ–‡ä»¶ä¸Šä¼ </h3>
          <el-form :model="fileSettings" label-width="150px" class="settings-form">
            <el-row :gutter="24">
              <el-col :span="12">
                <el-form-item label="æœ€å¤§æ–‡ä»¶å¤§å°(MB)">
                  <el-input-number 
                    v-model="fileSettings.maxFileSize" 
                    :min="1" 
                    :max="100"
                  />
                </el-form-item>
              </el-col>
              
              <el-col :span="12">
                <el-form-item label="å…è®¸çš„æ–‡ä»¶ç±»å‹">
                  <el-select 
                    v-model="fileSettings.allowedTypes" 
                    multiple 
                    placeholder="è¯·é€‰æ‹©å…è®¸çš„æ–‡ä»¶ç±»å‹"
                  >
                    <el-option label="å›¾ç‰‡ (jpg, png, gif)" value="image" />
                    <el-option label="æ–‡æ¡£ (pdf, doc, docx)" value="document" />
                    <el-option label="éŸ³é¢‘ (mp3, wav)" value="audio" />
                    <el-option label="è§†é¢‘ (mp4, avi)" value="video" />
                  </el-select>
                </el-form-item>
              </el-col>
            </el-row>
            
            <el-form-item label="å­˜å‚¨æ–¹å¼">
              <el-radio-group v-model="fileSettings.storageType">
                <el-radio label="local">æœ¬åœ°å­˜å‚¨</el-radio>
                <el-radio label="oss">é˜¿é‡Œäº‘OSS</el-radio>
                <el-radio label="qiniu">ä¸ƒç‰›äº‘</el-radio>
                <el-radio label="aws">AWS S3</el-radio>
              </el-radio-group>
            </el-form-item>
          </el-form>
        </div>

        <!-- CDNé…ç½® -->
        <div class="settings-section" v-if="fileSettings.storageType !== 'local'">
          <h3>â˜ï¸ CDNé…ç½®</h3>
          <el-form :model="fileSettings.cdn" label-width="150px" class="settings-form">
            <el-row :gutter="24">
              <el-col :span="12">
                <el-form-item label="è®¿é—®å¯†é’¥">
                  <el-input 
                    v-model="fileSettings.cdn.accessKey" 
                    placeholder="è¯·è¾“å…¥è®¿é—®å¯†é’¥"
                    show-password
                  />
                </el-form-item>
              </el-col>
              
              <el-col :span="12">
                <el-form-item label="ç§æœ‰å¯†é’¥">
                  <el-input 
                    v-model="fileSettings.cdn.secretKey" 
                    placeholder="è¯·è¾“å…¥ç§æœ‰å¯†é’¥"
                    show-password
                  />
                </el-form-item>
              </el-col>
            </el-row>
            
            <el-row :gutter="24">
              <el-col :span="12">
                <el-form-item label="å­˜å‚¨æ¡¶åç§°">
                  <el-input v-model="fileSettings.cdn.bucket" placeholder="è¯·è¾“å…¥å­˜å‚¨æ¡¶åç§°" />
                </el-form-item>
              </el-col>
              
              <el-col :span="12">
                <el-form-item label="è®¿é—®åŸŸå">
                  <el-input v-model="fileSettings.cdn.domain" placeholder="https://cdn.example.com" />
                </el-form-item>
              </el-col>
            </el-row>
            
            <el-form-item>
              <el-button @click="testCdnConnection" :loading="testingCdn">
                æµ‹è¯•è¿æ¥
              </el-button>
            </el-form-item>
          </el-form>
        </div>
      </el-tab-pane>

      <!-- é‚®ä»¶è®¾ç½® -->
      <el-tab-pane label="é‚®ä»¶è®¾ç½®" name="email">
        <div class="settings-section">
          <h3>ğŸ“§ SMTPé…ç½®</h3>
          <el-form :model="emailSettings" label-width="120px" class="settings-form">
            <el-row :gutter="24">
              <el-col :span="12">
                <el-form-item label="SMTPæœåŠ¡å™¨">
                  <el-input v-model="emailSettings.host" placeholder="smtp.example.com" />
                </el-form-item>
              </el-col>
              
              <el-col :span="12">
                <el-form-item label="ç«¯å£">
                  <el-input-number v-model="emailSettings.port" :min="1" :max="65535" />
                </el-form-item>
              </el-col>
            </el-row>
            
            <el-row :gutter="24">
              <el-col :span="12">
                <el-form-item label="ç”¨æˆ·å">
                  <el-input v-model="emailSettings.username" placeholder="è¯·è¾“å…¥é‚®ç®±ç”¨æˆ·å" />
                </el-form-item>
              </el-col>
              
              <el-col :span="12">
                <el-form-item label="å¯†ç ">
                  <el-input 
                    v-model="emailSettings.password" 
                    type="password" 
                    placeholder="è¯·è¾“å…¥é‚®ç®±å¯†ç "
                    show-password
                  />
                </el-form-item>
              </el-col>
            </el-row>
            
            <el-row :gutter="24">
              <el-col :span="12">
                <el-form-item label="å‘ä»¶äººåç§°">
                  <el-input v-model="emailSettings.fromName" placeholder="çº¢æ——å°å­¦è€ƒè¯•ç³»ç»Ÿ" />
                </el-form-item>
              </el-col>
              
              <el-col :span="12">
                <el-form-item label="å‘ä»¶äººé‚®ç®±">
                  <el-input v-model="emailSettings.fromEmail" placeholder="noreply@hqxx.edu.cn" />
                </el-form-item>
              </el-col>
            </el-row>
            
            <el-row :gutter="24">
              <el-col :span="12">
                <el-form-item label="å¯ç”¨SSL">
                  <el-switch 
                    v-model="emailSettings.ssl"
                    active-text="å¼€å¯"
                    inactive-text="å…³é—­"
                  />
                </el-form-item>
              </el-col>
              
              <el-col :span="12">
                <el-form-item label="å¯ç”¨TLS">
                  <el-switch 
                    v-model="emailSettings.tls"
                    active-text="å¼€å¯"
                    inactive-text="å…³é—­"
                  />
                </el-form-item>
              </el-col>
            </el-row>
            
            <el-form-item>
              <el-button @click="testEmailConnection" :loading="testingEmail">
                æµ‹è¯•é‚®ä»¶å‘é€
              </el-button>
            </el-form-item>
          </el-form>
        </div>
      </el-tab-pane>
    </el-tabs>

    <!-- ä¿å­˜æŒ‰é’® -->
    <div class="settings-actions">
      <el-button type="primary" @click="saveAllSettings" :loading="saving" size="large">
        ä¿å­˜æ‰€æœ‰è®¾ç½®
      </el-button>
      <el-button @click="resetSettings" size="large">
        é‡ç½®è®¾ç½®
      </el-button>
    </div>
  </PageLayout>
</template>

<script setup>
import { ref, reactive, onMounted } from 'vue'
import { ElMessage, ElMessageBox } from 'element-plus'
import api from '../utils/api'
import PageLayout from '../components/PageLayout.vue'

// å“åº”å¼æ•°æ®
const activeTab = ref('basic')
const saving = ref(false)
const testingCdn = ref(false)
const testingEmail = ref(false)

// åŸºç¡€è®¾ç½®
const basicSettings = reactive({
  schoolName: 'çº¢æ——å°å­¦',
  schoolCode: 'HQXX001',
  phone: '010-12345678',
  email: 'admin@hqxx.edu.cn',
  address: 'åŒ—äº¬å¸‚æœé˜³åŒºçº¢æ——è¡—123å·',
  description: 'çº¢æ——å°å­¦æ˜¯ä¸€æ‰€å…·æœ‰æ‚ ä¹…å†å²çš„ä¼˜ç§€å­¦æ ¡...',
  systemName: 'çº¢æ——å°å­¦è€ƒè¯•ç®¡ç†ç³»ç»Ÿ',
  version: 'v1.0.0',
  timezone: 'Asia/Shanghai',
  language: 'zh-CN',
  maintenanceMode: false,
  debugMode: false
})

// å®‰å…¨è®¾ç½®
const securitySettings = reactive({
  minPasswordLength: 6,
  maxLoginAttempts: 5,
  tokenExpireMinutes: 120,
  lockoutMinutes: 15,
  requireComplexPassword: true,
  enableTwoFactor: false,
  enableIpWhitelist: false,
  enableApiRateLimit: true,
  allowedIps: ''
})

// æ–‡ä»¶è®¾ç½®
const fileSettings = reactive({
  maxFileSize: 10,
  allowedTypes: ['image', 'document'],
  storageType: 'local',
  cdn: {
    accessKey: '',
    secretKey: '',
    bucket: '',
    domain: ''
  }
})

// é‚®ä»¶è®¾ç½®
const emailSettings = reactive({
  host: '',
  port: 587,
  username: '',
  password: '',
  fromName: 'çº¢æ——å°å­¦è€ƒè¯•ç³»ç»Ÿ',
  fromEmail: 'noreply@hqxx.edu.cn',
  ssl: false,
  tls: true
})

// ç”Ÿå‘½å‘¨æœŸ
onMounted(() => {
  loadSettings()
})

// æ–¹æ³•
async function loadSettings() {
  try {
    // æ¨¡æ‹ŸåŠ è½½è®¾ç½®
    // const response = await api.get('/system/settings')
    // Object.assign(basicSettings, response.data.basic)
    // Object.assign(securitySettings, response.data.security)
    // Object.assign(fileSettings, response.data.file)
    // Object.assign(emailSettings, response.data.email)
  } catch (error) {
    console.error('åŠ è½½ç³»ç»Ÿè®¾ç½®å¤±è´¥:', error)
  }
}

async function saveAllSettings() {
  try {
    saving.value = true
    
    const settings = {
      basic: basicSettings,
      security: securitySettings,
      file: fileSettings,
      email: emailSettings
    }
    
    // æ¨¡æ‹Ÿä¿å­˜è®¾ç½®
    await new Promise(resolve => setTimeout(resolve, 2000))
    // await api.post('/system/settings', settings)
    
    ElMessage.success('ç³»ç»Ÿè®¾ç½®ä¿å­˜æˆåŠŸ')
  } catch (error) {
    console.error('ä¿å­˜ç³»ç»Ÿè®¾ç½®å¤±è´¥:', error)
    ElMessage.error('ä¿å­˜ç³»ç»Ÿè®¾ç½®å¤±è´¥')
  } finally {
    saving.value = false
  }
}

async function resetSettings() {
  try {
    await ElMessageBox.confirm(
      'ç¡®å®šè¦é‡ç½®æ‰€æœ‰è®¾ç½®ä¸ºé»˜è®¤å€¼å—ï¼Ÿæ­¤æ“ä½œä¸å¯é€†ã€‚',
      'é‡ç½®ç¡®è®¤',
      {
        confirmButtonText: 'ç¡®è®¤é‡ç½®',
        cancelButtonText: 'å–æ¶ˆ',
        type: 'warning'
      }
    )
    
    await loadSettings()
    ElMessage.success('è®¾ç½®å·²é‡ç½®ä¸ºé»˜è®¤å€¼')
  } catch (error) {
    if (error !== 'cancel') {
      console.error('é‡ç½®è®¾ç½®å¤±è´¥:', error)
      ElMessage.error('é‡ç½®è®¾ç½®å¤±è´¥')
    }
  }
}

async function testCdnConnection() {
  try {
    testingCdn.value = true
    
    if (!fileSettings.cdn.accessKey || !fileSettings.cdn.secretKey) {
      ElMessage.warning('è¯·å¡«å†™å®Œæ•´çš„CDNé…ç½®ä¿¡æ¯')
      return
    }
    
    // æ¨¡æ‹Ÿæµ‹è¯•CDNè¿æ¥
    await new Promise(resolve => setTimeout(resolve, 2000))
    // await api.post('/system/test-cdn', fileSettings.cdn)
    
    ElMessage.success('CDNè¿æ¥æµ‹è¯•æˆåŠŸ')
  } catch (error) {
    console.error('CDNè¿æ¥æµ‹è¯•å¤±è´¥:', error)
    ElMessage.error('CDNè¿æ¥æµ‹è¯•å¤±è´¥')
  } finally {
    testingCdn.value = false
  }
}

async function testEmailConnection() {
  try {
    testingEmail.value = true
    
    if (!emailSettings.host || !emailSettings.username) {
      ElMessage.warning('è¯·å¡«å†™å®Œæ•´çš„é‚®ä»¶é…ç½®ä¿¡æ¯')
      return
    }
    
    // æ¨¡æ‹Ÿæµ‹è¯•é‚®ä»¶å‘é€
    await new Promise(resolve => setTimeout(resolve, 3000))
    // await api.post('/system/test-email', emailSettings)
    
    ElMessage.success('æµ‹è¯•é‚®ä»¶å‘é€æˆåŠŸ')
  } catch (error) {
    console.error('é‚®ä»¶å‘é€æµ‹è¯•å¤±è´¥:', error)
    ElMessage.error('é‚®ä»¶å‘é€æµ‹è¯•å¤±è´¥')
  } finally {
    testingEmail.value = false
  }
}
</script>

<style scoped>
.settings-tabs {
  background: rgba(255, 255, 255, 0.9);
  backdrop-filter: blur(10px);
  border-radius: 16px;
  padding: 24px;
  border: 1px solid rgba(255, 255, 255, 0.2);
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
}

.settings-section {
  margin-bottom: 32px;
}

.settings-section h3 {
  font-size: 18px;
  font-weight: 600;
  color: #2d3748;
  margin-bottom: 20px;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

.settings-form {
  background: rgba(248, 250, 252, 0.8);
  padding: 20px;
  border-radius: 12px;
  border: 1px solid rgba(226, 232, 240, 0.8);
}

.settings-actions {
  text-align: center;
  padding: 24px;
  background: rgba(255, 255, 255, 0.9);
  backdrop-filter: blur(10px);
  border-radius: 16px;
  border: 1px solid rgba(255, 255, 255, 0.2);
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
  margin-top: 24px;
}

/* æ·±è‰²æ¨¡å¼é€‚é… */
.dark .settings-tabs,
.dark .settings-actions {
  background: rgba(30, 30, 40, 0.9);
  border-color: rgba(255, 255, 255, 0.1);
}

.dark .settings-section h3 {
  color: #e2e8f0;
}

.dark .settings-form {
  background: rgba(255, 255, 255, 0.05);
  border-color: rgba(255, 255, 255, 0.1);
}

/* å“åº”å¼è®¾è®¡ */
@media (max-width: 768px) {
  .settings-tabs {
    padding: 16px;
  }
  
  .settings-form {
    padding: 16px;
  }
}
</style>
