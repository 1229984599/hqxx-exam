<template>
  <div class="max-w-6xl mx-auto animate-fade-in">
    <!-- æ¬¢è¿æ ‡é¢˜ -->
    <div class="text-center mb-16 relative">
      <!-- èƒŒæ™¯è£…é¥° -->
      <div class="absolute inset-0 -z-10">
        <div class="absolute top-10 left-1/4 w-32 h-32 bg-blue-200 rounded-full mix-blend-multiply filter blur-xl opacity-70 animate-pulse"></div>
        <div class="absolute top-20 right-1/4 w-32 h-32 bg-purple-200 rounded-full mix-blend-multiply filter blur-xl opacity-70 animate-pulse" style="animation-delay: 1s;"></div>
        <div class="absolute bottom-10 left-1/3 w-32 h-32 bg-pink-200 rounded-full mix-blend-multiply filter blur-xl opacity-70 animate-pulse" style="animation-delay: 2s;"></div>
      </div>

      <!-- ä¸»å›¾æ ‡ -->
      <div class="inline-flex items-center justify-center w-24 h-24 sm:w-28 sm:h-28 bg-gradient-to-br from-primary-500 via-purple-500 to-pink-500 rounded-3xl mb-8 shadow-large float-animation">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 sm:h-14 sm:w-14 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.746 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
        </svg>
      </div>

      <!-- æ ‡é¢˜ -->
      <h1 class="text-4xl sm:text-5xl lg:text-6xl font-bold mb-6 leading-tight">
        <span class="bg-gradient-to-r from-primary-600 via-purple-600 to-pink-600 bg-clip-text text-transparent">
          çº¢æ——å°å­¦
        </span>
        <br>
        <span class="bg-gradient-to-r from-gray-700 to-gray-900 bg-clip-text text-transparent">
          æ— çº¸åŒ–æµ‹è¯„ç³»ç»Ÿ
        </span>
      </h1>

    </div>

    <!-- é…ç½®å¡ç‰‡ -->
    <div class="card-modern p-8 mb-8">
      <div class="flex items-center mb-8">
        <div class="flex items-center justify-center w-12 h-12 bg-gradient-to-r from-primary-500 to-primary-600 rounded-xl mr-4 shadow-medium">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
          </svg>
        </div>
        <div>
          <h2 class="text-2xl font-bold text-gray-800 mb-1">å­¦ä¹ é…ç½®</h2>
          <p class="text-gray-600">è¯·é€‰æ‹©æ‚¨çš„å­¦ä¹ å‚æ•°ï¼Œå¼€å¯æ™ºèƒ½ç»ƒä¹ ä¹‹æ—…</p>
        </div>
      </div>
        
        <!-- å­¦æœŸçŠ¶æ€æç¤º -->
        <div v-if="configStore.semesterStatusMessage" class="mb-6 p-4 rounded-lg border-l-4" :class="{
          'bg-yellow-50 border-yellow-400': configStore.semesterStatusMessage.type === 'warning',
          'bg-red-50 border-red-400': configStore.semesterStatusMessage.type === 'error'
        }">
          <div class="flex items-center">
            <svg v-if="configStore.semesterStatusMessage.type === 'warning'" class="h-5 w-5 text-yellow-400 mr-2" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
            </svg>
            <svg v-else-if="configStore.semesterStatusMessage.type === 'error'" class="h-5 w-5 text-red-400 mr-2" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path>
            </svg>
            <p class="text-sm font-medium" :class="{
              'text-yellow-800': configStore.semesterStatusMessage.type === 'warning',
              'text-red-800': configStore.semesterStatusMessage.type === 'error'
            }">
              {{ configStore.semesterStatusMessage.message }}
            </p>
          </div>
        </div>

        <!-- å­¦æœŸè­¦å‘Šæç¤º -->
        <div v-if="semesterWarning" class="mb-6 p-4 rounded-lg border-l-4 bg-orange-50 border-orange-400">
          <div class="flex items-center">
            <svg class="h-5 w-5 text-orange-400 mr-2" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
            </svg>
            <p class="text-sm font-medium text-orange-800">
              {{ semesterWarning.message }}
            </p>
          </div>
        </div>

        <!-- é…ç½®è¡¨å• -->
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-2 xl:grid-cols-4 gap-6 lg:gap-8 config-grid-mobile">
          <!-- å­¦æœŸé€‰æ‹© -->
          <div class="space-y-3">
            <label class="flex items-center space-x-2 text-gray-700 font-semibold label-mobile">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-primary-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
              </svg>
              <span>å­¦æœŸ <span class="text-red-500">*</span></span>
            </label>
            <div class="relative group">
              <select
                v-model="configStore.selectedSemester"
                class="select-modern w-full"
                :disabled="configStore.loading || !configStore.hasValidSemesters"
                @change="onSemesterChange"
              >
                <option value="">{{ configStore.hasValidSemesters ? 'è¯·é€‰æ‹©å­¦æœŸ' : 'æš‚æ— å¯ç”¨å­¦æœŸ' }}</option>
                <option
                  v-for="semester in configStore.semesters"
                  :key="semester.id"
                  :value="semester.id"
                >
                  {{ semester.name }}
                </option>
              </select>
              <div class="select-icon-container">
                <svg xmlns="http://www.w3.org/2000/svg" class="select-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                </svg>
              </div>
            </div>
          </div>

          <!-- å¹´çº§é€‰æ‹© -->
          <div class="space-y-3">
            <label class="flex items-center space-x-2 text-gray-700 font-semibold label-mobile">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-primary-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
              </svg>
              <span>å¹´çº§ <span class="text-red-500">*</span></span>
            </label>
            <div class="relative group">
              <select
                v-model="configStore.selectedGrade"
                class="select-modern w-full"
                :disabled="configStore.loading"
              >
                <option value="">è¯·é€‰æ‹©å¹´çº§</option>
                <option
                  v-for="grade in configStore.grades"
                  :key="grade.id"
                  :value="grade.id"
                >
                  {{ grade.name }}
                </option>
              </select>
              <div class="select-icon-container">
                <svg xmlns="http://www.w3.org/2000/svg" class="select-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                </svg>
              </div>
            </div>
          </div>

          <!-- å­¦ç§‘é€‰æ‹© -->
          <div class="space-y-3">
            <label class="flex items-center space-x-2 text-gray-700 font-semibold label-mobile">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-primary-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.746 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
              </svg>
              <span>å­¦ç§‘ <span class="text-red-500">*</span></span>
            </label>
            <div class="relative group">
              <select
                v-model="configStore.selectedSubject"
                class="select-modern w-full"
                :disabled="configStore.loading"
                @change="onSubjectChange"
              >
                <option value="">è¯·é€‰æ‹©å­¦ç§‘</option>
                <option
                  v-for="subject in configStore.subjects"
                  :key="subject.id"
                  :value="subject.id"
                >
                  {{ subject.name }}
                </option>
              </select>
              <div class="select-icon-container">
                <svg xmlns="http://www.w3.org/2000/svg" class="select-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                </svg>
              </div>
            </div>
          </div>

          <!-- åˆ†ç±»é€‰æ‹© -->
          <div class="space-y-3">
            <label class="flex items-center space-x-2 text-gray-700 font-semibold label-mobile">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-primary-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z" />
              </svg>
              <span>åˆ†ç±» <span class="text-red-500">*</span></span>
            </label>
            <div class="relative group">
              <select
                v-model="configStore.selectedCategory"
                class="select-modern w-full"
                :disabled="configStore.loading || !configStore.selectedSubject"
              >
                <option value="">è¯·é€‰æ‹©åˆ†ç±»</option>
                <option
                  v-for="category in configStore.categories"
                  :key="category.id"
                  :value="category.id"
                >
                  {{ category.name }}
                </option>
              </select>
              <div class="select-icon-container">
                <svg xmlns="http://www.w3.org/2000/svg" class="select-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                </svg>
              </div>
            </div>
          </div>
        </div>
        
        <!-- åŠ è½½çŠ¶æ€ -->
        <div v-if="configStore.loading">
          <SkeletonLoader type="card" />
        </div>

        <!-- é”™è¯¯çŠ¶æ€ -->
        <div v-else-if="error">
          <ErrorState
            type="network"
            title="åŠ è½½é…ç½®å¤±è´¥"
            description="æ— æ³•åŠ è½½å­¦æœŸã€å¹´çº§ã€å­¦ç§‘ç­‰é…ç½®ä¿¡æ¯ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥"
            :tips="['æ£€æŸ¥ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸', 'åˆ·æ–°é¡µé¢é‡è¯•', 'è”ç³»ç®¡ç†å‘˜æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€']"
            @retry="retryLoadConfig"
          />
        </div>

        <!-- é…ç½®å®Œæˆæç¤º -->
        <div v-if="configStore.isConfigComplete" class="mt-8 p-6 success-state rounded-2xl animate-bounce-in">
          <div class="flex items-center space-x-4">
            <div class="flex-shrink-0">
              <div class="w-12 h-12 bg-green-500 rounded-full flex items-center justify-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
              </div>
            </div>
            <div class="flex-1">
              <h3 class="text-lg font-bold text-green-800 mb-1">ğŸ‰ é…ç½®å®Œæˆï¼</h3>
              <p class="text-sm text-green-700 leading-relaxed">{{ configStore.configSummary }}</p>
              <p class="text-xs text-green-600 mt-2 opacity-80">ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®å¼€å§‹æ‚¨çš„æ™ºèƒ½ç»ƒä¹ ä¹‹æ—…</p>
            </div>
          </div>
        </div>

        <!-- æ“ä½œæŒ‰é’® -->
        <div class="flex flex-col sm:flex-row items-center justify-center gap-6 mt-12">
          <!-- ä¸»è¦æ“ä½œæŒ‰é’® -->
          <button
            class="btn-primary-modern btn-modern-lg w-full sm:w-auto order-1 relative overflow-hidden group"
            @click="startPractice"
            :disabled="!configStore.isConfigComplete || loading"
          >
            <!-- æŒ‰é’®èƒŒæ™¯åŠ¨ç”» -->
            <div class="absolute inset-0 bg-gradient-to-r from-primary-400 to-primary-600 opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>

            <!-- æŒ‰é’®å†…å®¹ -->
            <div class="relative flex items-center justify-center">
              <span v-if="loading" class="animate-spin rounded-full h-6 w-6 border-b-2 border-white mr-3"></span>
              <svg v-else xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-3 group-hover:scale-110 transition-transform duration-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
              </svg>
              <span class="font-bold">å¼€å§‹æ™ºèƒ½ç»ƒä¹ </span>
            </div>
          </button>

          <!-- æ¬¡è¦æ“ä½œæŒ‰é’® -->
          <button
            class="btn-secondary-modern btn-modern-sm w-full sm:w-auto order-2 group"
            @click="clearConfig"
            :disabled="!configStore.isConfigComplete"
          >
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 group-hover:rotate-180 transition-transform duration-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
            </svg>
            é‡ç½®é…ç½®
          </button>
        </div>

        <!-- æç¤ºä¿¡æ¯ -->
        <div v-if="!configStore.isConfigComplete" class="text-center mt-6">
          <p class="text-gray-500 text-sm">è¯·å®Œæˆä¸Šæ–¹é…ç½®åå¼€å§‹ç»ƒä¹ </p>
        </div>
      </div>
    </div>
    

</template>

<script setup>
import { ref } from 'vue'
import { useRouter } from 'vue-router'
import { useConfigStore } from '../stores/config'
import { useQuestionsStore } from '../stores/questions'
import { message } from '../utils/message.js'
import SkeletonLoader from '../components/SkeletonLoader.vue'
import ErrorState from '../components/ErrorState.vue'

const router = useRouter()
const configStore = useConfigStore()
const questionsStore = useQuestionsStore()

const loading = ref(false)
const error = ref(false)
const semesterWarning = ref(null)

// é‡è¯•åŠ è½½é…ç½®
const retryLoadConfig = async () => {
  try {
    error.value = false
    await configStore.loadAllData()
  } catch (err) {
    console.error('é‡è¯•åŠ è½½é…ç½®å¤±è´¥:', err)
    error.value = true
    message.error('é‡è¯•å¤±è´¥ï¼Œè¯·ç¨åå†è¯•')
  }
}

// ç›‘å¬å­¦æœŸå˜åŒ–ï¼Œæ£€æŸ¥å­¦æœŸçŠ¶æ€
const onSemesterChange = async () => {
  semesterWarning.value = null

  if (configStore.selectedSemester) {
    try {
      const { apiService } = await import('../utils/api.js')
      const statusResult = await apiService.checkSemesterStatus(configStore.selectedSemester)

      if (statusResult.warning) {
        semesterWarning.value = {
          type: 'warning',
          message: statusResult.warning
        }
      }
    } catch (err) {
      console.error('æ£€æŸ¥å­¦æœŸçŠ¶æ€å¤±è´¥:', err)
      // ä¸æ˜¾ç¤ºé”™è¯¯ï¼Œé¿å…å¹²æ‰°ç”¨æˆ·ä½“éªŒ
    }
  }
}

// ç›‘å¬å­¦ç§‘å˜åŒ–ï¼Œé‡æ–°åŠ è½½åˆ†ç±»
const onSubjectChange = async () => {
  try {
    configStore.selectedCategory = null
    if (configStore.selectedSubject) {
      await configStore.loadCategories(configStore.selectedSubject)
    }
  } catch (err) {
    console.error('åŠ è½½åˆ†ç±»å¤±è´¥:', err)
    message.error('åŠ è½½åˆ†ç±»å¤±è´¥ï¼Œè¯·é‡è¯•')
  }
}

// æ¸…ç©ºé…ç½®
const clearConfig = () => {
  configStore.clearConfig()
  questionsStore.clearQuestions()
  message.success('é…ç½®å·²æ¸…ç©º', {
    description: 'æ‚¨å¯ä»¥é‡æ–°é€‰æ‹©é…ç½®å‚æ•°',
    duration: 2000
  })
}

// å¼€å§‹ç»ƒä¹ 
const startPractice = async () => {
  if (!configStore.isConfigComplete) return

  try {
    loading.value = true

    const config = {
      semester_id: configStore.selectedSemester,
      grade_id: configStore.selectedGrade,
      subject_id: configStore.selectedSubject,
      category_id: configStore.selectedCategory
    }

    // æ£€æŸ¥é…ç½®æ˜¯å¦æ”¹å˜ï¼Œå¦‚æœæ”¹å˜åˆ™é‡æ–°åŠ è½½æ‰€æœ‰è¯•é¢˜
    if (questionsStore.isConfigChanged(config)) {
      console.log('é…ç½®å·²æ”¹å˜ï¼Œé‡æ–°åŠ è½½è¯•é¢˜æ•°æ®...')
      await questionsStore.loadAllQuestions(config)
    }

    // æ£€æŸ¥æ˜¯å¦æœ‰è¯•é¢˜
    if (!questionsStore.hasQuestions) {
      // æ£€æŸ¥æ˜¯å¦æ˜¯å­¦æœŸæ—¶é—´ç›¸å…³çš„é”™è¯¯
      if (questionsStore.error && questionsStore.error.includes('å­¦æœŸ')) {
        message.warning(questionsStore.error, {
          description: 'è¯·è”ç³»ç®¡ç†å‘˜æˆ–ç­‰å¾…å­¦æœŸå¼€å¯',
          duration: 5000
        })
      } else {
        message.warning('è¯¥é…ç½®ä¸‹æš‚æ— è¯•é¢˜ï¼Œè¯·é€‰æ‹©å…¶ä»–é…ç½®', {
          description: 'è¯·å°è¯•é€‰æ‹©å…¶ä»–å­¦æœŸã€å¹´çº§ã€å­¦ç§‘æˆ–åˆ†ç±»'
        })
      }
      return
    }

    // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
    message.success('å‡†å¤‡å°±ç»ªï¼Œå¼€å§‹ç»ƒä¹ ï¼', {
      // description: `å·²ä¸ºæ‚¨å‡†å¤‡ ${questionsStore.totalQuestions} é“ç²¾é€‰è¯•é¢˜`,
      duration: 2000
    })

    // è·³è½¬åˆ°è¯•é¢˜é¡µé¢
    await router.push('/questions')

  } catch (error) {
    console.error('å¼€å§‹ç»ƒä¹ å¤±è´¥:', error)

    // æ£€æŸ¥æ˜¯å¦æ˜¯å­¦æœŸæ—¶é—´ç›¸å…³çš„é”™è¯¯
    if (error.response?.data?.detail?.type === 'semester_time_error') {
      const errorDetail = error.response.data.detail
      message.error(errorDetail.message, {
        description: 'è¯·è”ç³»ç®¡ç†å‘˜æˆ–ç­‰å¾…å­¦æœŸå¼€å¯',
        duration: 5000
      })
    } else {
      message.error('å¼€å§‹ç»ƒä¹ å¤±è´¥', {
        description: 'è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥åé‡è¯•',
        duration: 4000
      })
    }
  } finally {
    loading.value = false
  }
}
</script>

<style scoped>
.card {
  transition: transform 0.2s ease;
}

.card:hover {
  transform: translateY(-2px);
}
</style>
